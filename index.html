<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=<device-width>, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
  <title>Document</title>
  <style>
    .card {
      align-items: center;
    }

    .card-img-top {}

    a {
      color: darkgrey;
    }

    body {
      background-color: rgb(43, 42, 42);
    }
    #toolTip{
      background-color: black;
      color: rgb(177, 177, 177);
      border-radius: 5%;
      padding: 5px;
      z-index: 1000;
    }
  </style>
</head>


<body>
  <header class="bg-info jumbotron jumbotron-fluid sticky-top">
    <div class="container">
      <div class="row inline" id="header">
        <div class="col-4 align-items-center">
         <h1>Record Collection</h1>
        </div>
      </div>
    </div>

  <ul class="nav nav-pills nav-justified bg-dark" id="pagination">

  </ul>
  
  </header>
  <div>
    <div class="float-start col-1 position-fixed mt-2" role="tooltip" id="toolTip"></div>
  <div class="container mainClass">
    <div id="myData" class="row col align-items-center mx-auto d-flex justify-content-center"></div>
  </div>


  <div id="releaseModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header sticky-top bg-dark align-items-center" id="modalHeader">
          <a href="" target="blank" id="pageLink">
            <h3 class="modal-title" id="modalTitle"></h3>
          </a>
          <button type="button" class="close" onclick="hideModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="row row-content  align-items-center">
            <div class="media col-sm-4 col-md-3"  id="modalBody">
              <img class="ml-3 img-thumbnail" src="" id="modalImage" />
              <div class="media body" id="mediaBody">

              </div>
            </div>


            <div class="col" id="video">


            </div>
           
            </div>


          </div>
        </div>

      </div>
    </div>
  </div>
</div>





  <script>
    let start = 1;
    const mainContainer = document.getElementById("myData");
    let numRecs = getData(start);


    function getValue(numRecs){
    fetch(
      "https://api.discogs.com/users/sean_mustache/collection/value?token="+ process.env.TOKEN;
    )
      .then((response) => response.json())
      .then((value) => createToolTip(value, numRecs));
    }

    
    createData(start);
    
    function createTab(data, currentPage){  
    let nav = document.getElementById("pagination");
    for (i = 1; i < data.pagination.pages; i++) {
        let page = document.createElement("li");
        page.className = "nav-item";
        page.id = "page" + i;
        let num=i;
        
        if (i == currentPage) {
          
          page.className = "nav-link active bg-secondary";
          page.innerHTML = i;
          page.onclick = function () { createData(num) };
        } else {
          page.className = "nav-link";
          page.onclick = function () { createData(num)};
          page.innerHTML = i;
        }
        
        nav.appendChild(page);
      }
     
    }
    function getData(currentPage){ 
      fetch(
      "https://api.discogs.com/users/sean_mustache/collection/folders/0/releases?sort=artist&page=" +
      currentPage +
      "&token="+process.env.TOKEN;
    )
      .then((response) => response.json())
      .then((data) => numberOfRecords(data));
      
    }
    function createData(currentPage) {
      
    
        
        fetch(
          "https://api.discogs.com/users/sean_mustache/collection/folders/0/releases?sort=artist&page=" +
          currentPage +
          "&token=" + process.env.TOKEN;
        )
          .then((response) => response.json())
          .then((data) => appendData(data,currentPage));

      }
   
    
    function appendData(data, currentPage) {
      $(".mainClass").hide(400);
      clearScreen(mainContainer);
      clearScreen(pagination);
      createTab(data,currentPage);
      data.releases.forEach((release) => {
        let record = release;
        let card = document.createElement("div");
        card.className = "card col-12 col-sm-12 col-md-5 col-lg-5 col-xl-3 bg-secondary m-3 pt-2";
        let image = document.createElement("img");
        card.onclick = function () { getModal(record.id) };
        card.id="card-"+record.id;
        image.className = "card-img-top m-1";
        image.src = record.basic_information.cover_image;
        let div = document.createElement("div");
        div.className = "card-body bg-secondary text-white col-12";
        div.innerHTML =
          "<strong>Artist:</strong><br>" +
          (record.basic_information.artists[0].name).replace(/ ((\(\d)\)) */g, "") +
          "<br/>" +
          "<strong>Title:</strong><br>" +
          record.basic_information.title;
        card.appendChild(image);
        card.appendChild(div);
        setTimeout(function(){card.appendChild(div);},1000);
        mainContainer.appendChild(card);
      });
      $(".mainClass").fadeIn("slow"); 
    }

    function numberOfRecords(data){
      getValue(data.pagination.items);   
    }

    function createToolTip(value, numRecs) {
      let toolTip = document.getElementById("toolTip");
      toolTip.innerHTML=
      "Number of Records: " + numRecs+
        "<br>Collection Value: <br> Low:" +
        value.minimum +
        " <br> Median: " +
        value.median +
        "  <br>Maximum: " +
        value.maximum;
    }

    function getModal(discogsId) {
      console.log(discogsId);
      fetch(
        "https://api.discogs.com/releases/" + discogsId + "?usd&token="+ process.env.TOKEN;
      )
        .then((response) => response.json())
        .then((individualData) => createModal(individualData));
    }

    function createModal(individualData) {

      console.log(individualData);
      let artistTitle = document.getElementById("modalTitle");
      artistTitle.innerHTML = "" + (individualData.artists[0].name + ": " + individualData.title).replace(/ ((\(\d)\)) */g, "");
      let link = document.getElementById("pageLink");
      link.href = individualData.uri;
      let modalBody = document.getElementById("modalBody");
      let img = document.getElementById("modalImage");
      img.src = individualData.images[0].uri;
      img.height = "100";
      let mediaBody = document.getElementById("mediaBody");
      mediaBody.innerHTML = "Release Date: " + individualData.year + "<br/>Label: " + individualData.labels[0].name + "<br/>Lowest Price Available: <a target='blank' href= 'https://www.discogs.com/sell/release/" + individualData.id + "'>$" + individualData.lowest_price + "</a>";
      let videoDiv = document.getElementById("video");
      if (individualData.videos != undefined) {
        let videoURL = individualData.videos[0].uri.split("v=");

        videoDiv.innerHTML = '<iframe width="560" height="315" src="https://www.youtube.com/embed/' + videoURL[1] + '" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>'
      }
      else {
        videoDiv.innerHTML = "No Video Available :(  <a href='https://www.youtube.com/results?search_query=" + ((individualData.artists[0].name + " " + individualData.title).replace(/ ((\(\d)\)) */g, "")).replace(/ (" ") */g, "+") + "' target='blank'> Click Here to search Youtube for videos </a>";
      }
      $("#releaseModal").modal("show");
    }

    function hideModal() {
      $("#releaseModal").modal("hide");
    }

    function clearScreen(element){
      while (element.firstChild){
        element.removeChild(element.firstChild);
      }
    
    }
  </script>
  <script src="node_modules/jquery/dist/jquery.js"></script>
  <script src="node_modules/popper.js/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
</body>

</html>